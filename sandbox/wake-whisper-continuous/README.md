# Wake Word + Whisper 統合実験サンドボックス

## 概要
ウェイクワード検出（Porcupine）と音声認識（Whisper）を統合したプロトタイプの実験場。

## 実装の進化

### 1. シンプル統合版 (main.py)
- 基本的な統合実装
- ウェイクワード → 録音 → 文字起こし

### 2. マルチレベル認識版 (multilevel_main.py)
- 3秒/8秒/20秒の段階的認識
- JSON形式のログ出力
- リアルタイム性の向上

### 3. イベント駆動版 (event_driven_v3.py)
- 独立したマイク入力ストリーム
- 共有リングバッファ
- Whisperベースの終了判定

## 主な成果

### ✅ 実現できたこと
1. **日本語ウェイクワード対応** - 「オッケーセバス」
2. **マルチ言語同時検出** - 日本語と英語のウェイクワード
3. **リアルタイムマルチレベル認識** - 段階的な精度向上
4. **JSON形式のログ** - 機械可読な出力
5. **タイムスタンプベースの音声分離** - ウェイクワード部分の除外

### ❌ 課題
1. **環境ノイズでの無音検出** - リビング環境では困難
2. **複雑性の増大** - 機能追加で管理が困難に
3. **終了判定の難しさ** - 単純な無音検出では不十分

## 学んだ教訓

### アーキテクチャ
- **単機能プロセスの方が良い** - UNIXの哲学に従う
- **疎結合が重要** - APIやメッセージキューで連携
- **複雑な統合より単純な連携** - 各機能に集中できる

### 技術的知見
1. **ウェイクワード検出は独立ストリームで** - 文字起こしと分離
2. **リングバッファは文字起こし専用に** - 長時間録音用
3. **VADの必要性** - 環境ノイズ対策にはVoice Activity Detection

## 今後の方向性

独立したマイクロサービスとして実装：
1. **ウェイクワード検出サービス**
   - 専用プロセス
   - イベント通知のみ

2. **音声認識サービス**
   - Whisper専用
   - RESTful APIまたはgRPC

3. **オーケストレーター**
   - サービス間の連携
   - ビジネスロジック

## ファイル構成

### コア実装
- `main.py` - 初期統合版
- `multilevel_main.py` - マルチレベル認識版
- `event_driven_v3.py` - 最新のイベント駆動版

### サポートモジュール
- `config.py` - 設定管理
- `wake_detector_auto.py` - ウェイクワード検出器ファクトリー
- `multilingual_wake_detector.py` - 多言語対応検出器
- `audio_recorder.py` - マルチレベル音声録音
- `simple_whisper_processor.py` - Whisper処理
- `database.py` - DuckDBストレージ

### ヘルパー
- `porcupine_helper.py` - Porcupineモデル自動ダウンロード

## アーカイブ対象
- `event_driven_fixed.py` - デバッグ版
- `event_driven_v2.py` - 改善版（v3に統合）
- 各種テストファイル

## まとめ
統合アプローチは魅力的だが、複雑性が増すにつれて管理が困難になる。
単機能のマイクロサービスとして実装し、メッセージングで連携する方が、
保守性・拡張性・信頼性の面で優れている。