# TTS（音声合成）実装ガイド

## 概要

Voice Agentプロジェクトにおける音声合成（Text-to-Speech）機能の実装に関する技術的な知見をまとめたドキュメントです。

## 検証済みTTSライブラリ

### 1. VOICEVOX（推奨）
- **特徴**: 高品質な日本語音声合成、多様な話者、オフライン動作可能
- **レイテンシ**: 0.3-0.6秒（最適化後）
- **セットアップ**: 
  ```bash
  # エンジンのダウンロードと起動
  uv run python voicevox_manager.py setup
  uv run python voicevox_manager.py start
  ```
- **使用方法**: HTTPエンドポイント経由（ポート50021）

### 2. pyopenjtalk
- **特徴**: 軽量、高速（0.03-0.09秒）
- **音質**: 機械的だが実用的
- **用途**: レスポンス重視の場面

### 3. macOS say コマンド
- **特徴**: macOS標準、セットアップ不要
- **レイテンシ**: 0.7-0.8秒
- **制限**: macOSのみ、日本語音声は限定的

### 4. pyttsx3
- **状態**: macOSで動作不安定（AttributeError）
- **推奨**: 使用しない

## アーキテクチャ設計

### レイヤー構造

```
┌─────────────────────────────────────┐
│     アプリケーション層              │
├─────────────────────────────────────┤
│     TTS APIサーバー層               │
│  - Simple API (ポート8000)          │
│  - Queue API (ポート8001)           │
│  - Priority API (ポート8002)        │
│  - Adaptive API (ポート8003)        │
├─────────────────────────────────────┤
│     VOICEVOXエンジン層              │
│  - HTTPサーバー (ポート50021)       │
└─────────────────────────────────────┘
```

### API設計パターン

1. **シンプルAPI**: 即座に音声再生、オーバーラップ可能
2. **キューAPI**: 順次再生、`queue`パラメータで制御
3. **優先度API**: 4段階の優先度、緊急割り込み機能
4. **適応型API**: 環境音に基づく自動音量調整

## 実装のベストプラクティス

### 1. レイテンシ最適化
```python
# VOICEVOXの高速化設定
audio_query['speedScale'] = 1.2
audio_query['pauseLength'] = 0.1
audio_query['pauseLengthScale'] = 0.3
```

### 2. 音声再生の実装
```python
# macOSでの音量調整付き再生
subprocess.Popen(
    ['afplay', '-v', str(volume_percent), temp_path],
    stdout=subprocess.DEVNULL,
    stderr=subprocess.DEVNULL
)
```

### 3. 環境適応型音量
- 騒音レベル（dB）に基づく動的調整
- 時間帯・場所による静的調整
- 将来的にはマルチセンサー統合

## 高度な機能

### 1. 優先度ベース再生
- `low`, `normal`, `high`, `urgent` の4段階
- 緊急メッセージは現在の再生を中断
- 中断後の自動再開機能

### 2. 環境適応
- マイクによる騒音レベルモニタリング
- 時間帯別の音量調整
- 場所別の音量プリセット

### 3. マルチセンサー統合（将来構想）
- 明るさセンサー: 就寝/起床の判定
- 温度センサー: 快適度に基づく話速調整
- 人感センサー: 人の存在による音量調整
- CO2センサー: 換気アラートの優先度調整

## CLIツール

### vsay - 基本的な音声合成
```bash
./vsay "こんにちは"
./vsay -s 2 "四国めたんです"  # 話者変更
./vsay -r 1.5 "速く話します"   # 速度調整
```

### vsay2 - APIサーバー経由
```bash
./vsay2 "APIサーバー経由で話します"
./vsay2 --list  # 話者一覧
```

## トラブルシューティング

### VOICEVOXエンジンが起動しない
```bash
# プロセスを確認
ps aux | grep voicevox

# 強制終了して再起動
pkill -f voicevox_engine
uv run python voicevox_manager.py start
```

### 音声が出力されない
- afplayコマンドの存在確認: `which afplay`
- 音量設定の確認
- 一時ファイルのパーミッション確認

## パフォーマンス指標

| ライブラリ | レイテンシ | 音質 | CPU使用率 |
|-----------|-----------|------|-----------|
| VOICEVOX | 0.3-0.6秒 | 高 | 中 |
| pyopenjtalk | 0.03-0.09秒 | 中 | 低 |
| macOS say | 0.7-0.8秒 | 中 | 低 |

## 今後の展望

1. **リアルタイム性の向上**
   - ストリーミング音声合成の実装
   - 音声のチャンク単位での再生

2. **感情表現の追加**
   - VOICEVOXのスタイル機能活用
   - 文脈に応じた話者切り替え

3. **スマートホーム統合**
   - Home Assistant連携
   - 部屋ごとのスピーカー制御

4. **エッジデバイス対応**
   - Raspberry Pi最適化
   - 低消費電力モードの実装