# 作業日誌: TTS（音声合成）実装

**日付**: 2025-06-27  
**作業者**: Claude  
**ブランチ**: feature-tts-comparison

## 作業概要

Voice Agentプロジェクトの音声合成部分の実装を行いました。複数のTTSライブラリを検証し、VOICEVOXを中心とした音声合成システムを構築しました。

## 実施内容

### 1. TTSライブラリの検証

検証したライブラリ：
- **pyttsx3**: macOSで動作不安定のため不採用
- **macOS say**: 0.7-0.8秒のレイテンシで動作確認
- **pyopenjtalk**: 0.03-0.09秒の高速動作を確認
- **VOICEVOX**: 高品質な日本語音声、0.3-0.6秒（最適化後）

### 2. VOICEVOXの詳細実装

- エンジンのダウンロード・セットアップスクリプト作成
- マネージャークラスによるライフサイクル管理
- 音声パラメータの最適化（speedScale=1.2等）
- バサラさん讃えデモによる音質確認
- アクセント調整機能の実装

### 3. APIサーバーの実装

4種類のAPIサーバーを実装：

1. **Simple API（ポート8000）**
   - 基本的な音声再生機能
   - オーバーラップ再生対応

2. **Queue API（ポート8001）**
   - キューによる順次再生
   - オプションでオーバーラップも可能

3. **Priority API（ポート8002）**
   - 4段階の優先度管理
   - 緊急割り込み機能
   - 中断後の自動再開

4. **Adaptive API（ポート8003）**
   - 環境音モニタリング
   - 騒音レベルに基づく自動音量調整
   - 時間帯・場所による調整

### 4. CLIツールの作成

- `vsay`: VOICEVOXを直接利用する高速ツール
- `vsay2`: APIサーバー経由のツール

### 5. 高度な機能の実装

- 環境適応型音量調整システム
- マルチセンサー統合の設計（将来構想）
- 明るさ・温度・人感センサーとの連携案

## 技術的な発見

### レイテンシ最適化
- VOICEVOXのパラメータ調整で大幅改善
- 一時ファイル経由の再生が必要（afplayの制限）
- API経由でも実用的な速度を達成

### 音声再生の課題
- macOSのafplayはパイプ入力非対応
- 音量調整は`-v`オプションで実現
- 複数プロセスによるオーバーラップ再生が可能

### 環境適応の可能性
- マイクによる騒音レベル取得は実用的
- 複数センサーの統合で高度な状況認識が可能
- スマートホーム連携の大きな可能性

## 得られた知見

1. **VOICEVOXが最適解**
   - 音質・機能・拡張性のバランスが良い
   - オフライン動作可能
   - 豊富な話者とスタイル

2. **レイヤー化の重要性**
   - エンジン層とAPI層の分離
   - 用途別のAPI設計
   - 将来の拡張を考慮した設計

3. **環境認識の価値**
   - 状況に応じた音量調整は実用的
   - マルチセンサー統合で更なる改善可能
   - ユーザー体験の大幅向上

## 今後の課題

1. ストリーミング音声合成の実装
2. 感情表現の追加
3. エッジデバイスでの最適化
4. スマートホーム統合

## ファイル一覧

### 本番用ファイル
- `voicevox_manager.py` - VOICEVOXエンジン管理
- `vsay` - 基本CLIツール
- `tts_api_server.py` - Simple API
- `tts_api_priority.py` - Priority API
- `tts_api_adaptive.py` - Adaptive API

### アーカイブ予定
- 各種テストスクリプト
- デモ用スクリプト
- 中間バージョンのファイル

## 参考リンク

- [VOICEVOX公式](https://voicevox.hiroshiba.jp/)
- [pyopenjtalk](https://github.com/r9y9/pyopenjtalk)
- [FastAPI](https://fastapi.tiangolo.com/)