# 作業日誌: ウェイクワード検出問題の調査（2025-06-27）

## 概要
イベント駆動型アーキテクチャの実装でウェイクワード検出が動作しない問題を調査

## 問題の症状
- 音声バッファは正常に蓄積されている
- フレーム長とチャンクサイズは一致（512サンプル）
- 音声レベル（RMS）も正常に取得できている
- しかしウェイクワード検出イベントが発生しない

## 試した対策

### 1. イベント駆動型実装 (event_driven_fixed.py)
- 共有リングバッファを使用
- ウェイクワード検出と文字起こしが同じバッファを共有
- 結果: ウェイクワード検出が動作しない

### 2. 独立ストリーム実装 (event_driven_v2.py)
- ユーザーの提案を採用
- ウェイクワード検出用に独立したマイクストリーム
- リングバッファは文字起こし専用
- 結果: 音声入力は正常だがウェイクワードが検出されない

## デバッグ情報から分かったこと

```json
{"timestamp": 1751011584.026795, "event": "debug_audio_level", "data": {"frame": 3100, "rms": 235.35890197753906, "max": 501, "min": -552}}
```

- 音声レベルは正常（RMS値が適切に変動）
- 大きな音（話し声）も記録されている（RMS > 200）
- MultilingualWakeWordDetectorは正常に初期化
- 使用可能なウェイクワード: ["オッケーセバス_ja_mac_v3_0_0", "ok google", "alexa", "jarvis", "computer", "picovoice"]

## 考えられる原因

1. **Porcupineの感度設定**
   - 現在の感度: 0.5
   - 低すぎる可能性がある

2. **音声フォーマットの問題**
   - PyAudioから取得した音声データのフォーマット
   - numpy配列への変換で問題がある可能性

3. **コールバックの問題**
   - process_audio()の戻り値を確認していない
   - MultilingualWakeWordDetectorのコールバックが正しく動作していない可能性

## 次のステップ

1. 感度を上げてテスト（0.5 → 0.7 or 0.9）
2. 単純なウェイクワード検出テストを作成
3. process_audio()の戻り値を直接確認
4. 既存の動作していた実装（multilevel_main.py）との比較

## 教訓
- ウェイクワード検出は独立したストリームで処理するのが良い設計
- リングバッファは文字起こしなど長時間の音声処理に適している
- デバッグログは問題特定に非常に重要