# システムアーキテクチャ設計書

## 概要

音声エージェントシステムは、音声入力を受け付け、意図を理解し、適切なアクションを実行するシステムです。

## アーキテクチャ図

```
┌─────────────────┐     ┌─────────────────┐
│   マイク入力     │     │  スピーカー出力  │
└────────┬────────┘     └────────▲────────┘
         │                       │
         ▼                       │
┌─────────────────────────────────────────┐
│           クライアント層                   │
│  ┌─────────────┐    ┌─────────────┐   │
│  │ 音声キャプチャ │    │  音声再生    │   │
│  └──────┬──────┘    └──────▲──────┘   │
│         │                    │          │
│         ▼                    │          │
│  ┌─────────────────────────────────┐   │
│  │     WebSocket クライアント        │   │
│  └─────────────┬───────────────────┘   │
└────────────────┼───────────────────────┘
                 │ WebSocket
                 ▼
┌─────────────────────────────────────────┐
│            サーバー層                     │
│  ┌─────────────────────────────────┐   │
│  │     WebSocket サーバー           │   │
│  └──────┬──────────────────┬───────┘   │
│         │                   │           │
│         ▼                   ▼           │
│  ┌──────────────┐   ┌──────────────┐  │
│  │ 音声認識エンジン│   │音声合成エンジン│  │
│  └──────┬───────┘   └──────▲───────┘  │
│         │                   │           │
│         ▼                   │           │
│  ┌─────────────────────────────────┐   │
│  │      エージェントコア             │   │
│  │  ┌────────┐  ┌────────────┐   │   │
│  │  │意図理解 │  │アクション実行│   │   │
│  │  └────────┘  └──────┬─────┘   │   │
│  └─────────────────────┼─────────┘   │
└────────────────────────┼───────────────┘
                         │
                         ▼
┌─────────────────────────────────────────┐
│          外部サービス層                   │
│  ┌──────────┐ ┌──────────┐ ┌────────┐ │
│  │NatureRemo │ │SwitchBot │ │天気API │ │
│  └──────────┘ └──────────┘ └────────┘ │
└─────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. クライアント層

#### 音声キャプチャ
- マイクからの音声入力を取得
- VAD（Voice Activity Detection）による発話検出
- 音声データのストリーミング送信

#### WebSocketクライアント
- サーバーとのリアルタイム双方向通信
- 音声データの送信
- 応答の受信と再生指示

### 2. サーバー層

#### WebSocketサーバー
- クライアントとの接続管理
- メッセージルーティング
- セッション管理

#### 音声認識エンジン
- 音声データから文字列への変換
- 複数の音声認識APIの抽象化層
- 認識精度の最適化

#### 音声合成エンジン
- テキストから音声データへの変換
- 自然な話し方の実現
- 音声パラメータの調整

#### エージェントコア
- **意図理解**: 自然言語処理による意図の抽出
- **アクション実行**: 意図に基づいた適切なアクションの実行
- **コンテキスト管理**: 会話の文脈を保持

### 3. 外部サービス層
- 各種APIとの連携
- 認証情報の管理
- エラーハンドリング

## データフロー

1. **音声入力フロー**
   ```
   マイク → 音声キャプチャ → WebSocket → 音声認識 → 意図理解
   ```

2. **アクション実行フロー**
   ```
   意図理解 → アクション決定 → 外部API呼び出し → 結果処理
   ```

3. **音声応答フロー**
   ```
   結果処理 → 応答生成 → 音声合成 → WebSocket → スピーカー
   ```

## 技術選定の考慮点

### リアルタイム性
- WebSocketによる低遅延通信
- ストリーミング処理による即時応答

### 拡張性
- プラグインアーキテクチャの採用
- インターフェースによる疎結合設計

### 信頼性
- エラーリトライ機構
- フォールバック処理
- ログ収集と監視

## セキュリティ考慮事項

- APIキーの安全な管理
- 音声データの暗号化
- アクセス制御の実装